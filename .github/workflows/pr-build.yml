name: PR Build

on:
    pull_request_target:
        branches: [master]
        types: [opened, synchronize, reopened]

permissions:
    contents: read
    pull-requests: write
    checks: write
    statuses: write

env:
    PLUGIN_ID: yearly-glance

jobs:
    # å®‰å…¨æ£€æŸ¥ä½œä¸š - éªŒè¯ PR æ¥æº
    security-check:
        runs-on: ubuntu-latest
        outputs:
            is-safe: ${{ steps.check.outputs.is-safe }}
        steps:
            - name: Check PR safety
              id: check
              run: |
                  # æ£€æŸ¥æ˜¯å¦æ¥è‡ªåŒä¸€ä»“åº“æˆ–å…·æœ‰å®‰å…¨æ ‡ç­¾
                  if [[ "${{ github.event.pull_request.head.repo.full_name }}" == "${{ github.repository }}" ]] || \
                     [[ "${{ contains(github.event.pull_request.labels.*.name, 'safe-to-build') }}" == "true" ]]; then
                    echo "is-safe=true" >> $GITHUB_OUTPUT
                  else
                    echo "is-safe=false" >> $GITHUB_OUTPUT
                  fi

    build:
        runs-on: ubuntu-latest
        needs: security-check
        if: needs.security-check.outputs.is-safe == 'true'
        steps:
            - name: Checkout PR code
              uses: actions/checkout@v4
              with:
                  # é‡è¦ï¼šæ£€å‡º PR çš„ä»£ç è€Œä¸æ˜¯ç›®æ ‡åˆ†æ”¯
                  ref: ${{ github.event.pull_request.head.sha }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18.x"
                  cache: "npm"

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Build plugin
              run: yarn build

            - name: Prepare artifacts
              run: |
                  mkdir -p build-artifacts
                  cp main.js manifest.json styles.css build-artifacts/
                  cd build-artifacts
                  zip -r "${{ env.PLUGIN_ID }}-pr-${{ github.event.number }}.zip" .

            - name: Upload artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: plugin-pr-${{ github.event.number }}
                  path: build-artifacts/
                  retention-days: 7

            - name: Comment on PR
              uses: actions/github-script@v7
              with:
                  script: |
                      const prNumber = context.payload.pull_request.number;
                      const shortSha = context.payload.pull_request.head.sha.substring(0, 7);
                      const runId = context.runId;

                      const commentBody = `## ğŸ”§ PR æ„å»ºå®Œæˆ

                      **æ„å»ºä¿¡æ¯ï¼š**
                      - PR: #${prNumber}
                      - Commit: ${shortSha}
                      - æ„å»ºæ—¶é—´: ${new Date().toISOString()}

                      **ä¸‹è½½é“¾æ¥ï¼š**
                      [ä¸‹è½½æ’ä»¶æ„å»ºäº§ç‰©](https://github.com/${{ github.repository }}/actions/runs/${runId})

                      **å®‰è£…è¯´æ˜ï¼š**
                      1. ç‚¹å‡»ä¸Šæ–¹é“¾æ¥ä¸‹è½½æ„å»ºäº§ç‰©
                      2. è§£å‹ zip æ–‡ä»¶
                      3. å°†è§£å‹åçš„æ–‡ä»¶å¤¹å¤åˆ¶åˆ° Obsidian æ’ä»¶ç›®å½•ï¼š\`<vault>/.obsidian/plugins/${{ env.PLUGIN_ID }}/\`
                      4. åœ¨ Obsidian è®¾ç½®ä¸­å¯ç”¨æ’ä»¶

                      > âš ï¸ è¿™æ˜¯æµ‹è¯•æ„å»ºï¼Œä»…ç”¨äºé¢„è§ˆå’Œæµ‹è¯•ç›®çš„ã€‚`;

                      // æŸ¥æ‰¾ç°æœ‰çš„æ„å»ºè¯„è®º
                      const comments = await github.rest.issues.listComments({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: prNumber
                      });

                      const existingComment = comments.data.find(comment => 
                        comment.user.login === 'github-actions[bot]' && 
                        comment.body.includes('ğŸ”§ PR æ„å»ºå®Œæˆ')
                      );

                      if (existingComment) {
                        await github.rest.issues.updateComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          comment_id: existingComment.id,
                          body: commentBody
                        });
                      } else {
                        await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: prNumber,
                          body: commentBody
                        });
                      }

    build-status:
        runs-on: ubuntu-latest
        needs: [security-check, build]
        if: always() && needs.security-check.outputs.is-safe == 'true'
        steps:
            - name: Set commit status
              uses: actions/github-script@v7
              with:
                  script: |
                      const state = '${{ needs.build.result }}' === 'success' ? 'success' : 'failure';
                      const description = state === 'success' ? 'PR æ„å»ºæˆåŠŸ' : 'PR æ„å»ºå¤±è´¥';

                      await github.rest.repos.createCommitStatus({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        sha: '${{ github.event.pull_request.head.sha }}',
                        state: state,
                        description: description,
                        context: 'PR Build',
                        target_url: `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`
                      });
