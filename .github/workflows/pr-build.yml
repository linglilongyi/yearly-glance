name: PR Build

on:
    pull_request:
        types: [opened, synchronize, reopened]
        branches: [main, master, develop] # æ ¹æ®ä½ çš„ä¸»åˆ†æ”¯è°ƒæ•´
    pull_request_target:
        types: [opened, synchronize, reopened]
        branches: [main, master, develop]

permissions:
    contents: read
    pull-requests: write
    checks: write

env:
    PLUGIN_ID: yearly-glance

jobs:
    build:
        runs-on: ubuntu-22.04

        steps:
            - name: Checkout PR code
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.pull_request.head.sha }}
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: "18.x"
                  cache: "npm"

            - name: Install dependencies
              run: |
                  npm install -g yarn
                  yarn install --frozen-lockfile

            - name: Build project
              run: |
                  yarn run build --if-present

            - name: Prepare build artifacts
              run: |
                  mkdir -p ${{ env.PLUGIN_ID }}
                  cp main.js manifest.json styles.css ${{ env.PLUGIN_ID }}/
                  zip -r ${{ env.PLUGIN_ID }}-pr-${{ github.event.number }}.zip ${{ env.PLUGIN_ID }}

            - name: Upload build artifacts
              uses: actions/upload-artifact@v3
              with:
                  name: ${{ env.PLUGIN_ID }}-pr-${{ github.event.number }}
                  path: |
                      main.js
                      manifest.json
                      styles.css
                      ${{ env.PLUGIN_ID }}-pr-${{ github.event.number }}.zip
                  retention-days: 30

            - name: Comment PR with download link
              uses: actions/github-script@v6
              with:
                  script: |
                      const { owner, repo } = context.repo;
                      const prNumber = context.payload.pull_request.number;
                      const runId = context.runId;

                      const comment = `## ğŸ”¨ æ„å»ºå®Œæˆ

                      PR #${prNumber} çš„æ„å»ºäº§ç‰©å·²å‡†å¤‡å°±ç»ªï¼

                      ğŸ“¦ **ä¸‹è½½æ„å»ºäº§ç‰©ï¼š**
                      - [ç‚¹å‡»è¿™é‡Œä¸‹è½½ ${{ env.PLUGIN_ID }}-pr-${prNumber}.zip](https://github.com/${owner}/${repo}/actions/runs/${runId})

                      ğŸ”„ **å®‰è£…è¯´æ˜ï¼š**
                      1. ä¸‹è½½ä¸Šé¢çš„ zip æ–‡ä»¶
                      2. è§£å‹åˆ° Obsidian åº“çš„æ’ä»¶æ–‡ä»¶å¤¹ï¼š\`<vault>/.obsidian/plugins/${{ env.PLUGIN_ID }}/\`
                      3. é‡å¯ Obsidian
                      4. åœ¨è®¾ç½®ä¸­å¯ç”¨æ’ä»¶

                      âš ï¸ **æ³¨æ„ï¼š** è¿™æ˜¯ PR æ„å»ºç‰ˆæœ¬ï¼Œä»…ç”¨äºæµ‹è¯•ç›®çš„ã€‚

                      ---
                      *æ„å»ºæ—¶é—´ï¼š* ${new Date().toISOString()}
                      *æäº¤ï¼š* ${{ github.event.pull_request.head.sha.substring(0, 7) }}`;

                      // æŸ¥æ‰¾æ˜¯å¦å·²æœ‰æ„å»ºè¯„è®º
                      const comments = await github.rest.issues.listComments({
                        owner,
                        repo,
                        issue_number: prNumber
                      });

                      const existingComment = comments.data.find(comment => 
                        comment.body.includes('ğŸ”¨ æ„å»ºå®Œæˆ') && comment.user.type === 'Bot'
                      );

                      if (existingComment) {
                        // æ›´æ–°ç°æœ‰è¯„è®º
                        await github.rest.issues.updateComment({
                          owner,
                          repo,
                          comment_id: existingComment.id,
                          body: comment
                        });
                      } else {
                        // åˆ›å»ºæ–°è¯„è®º
                        await github.rest.issues.createComment({
                          owner,
                          repo,
                          issue_number: prNumber,
                          body: comment
                        });
                      }

    # å¯é€‰ï¼šæ·»åŠ æ„å»ºçŠ¶æ€æ£€æŸ¥
    build-status:
        runs-on: ubuntu-22.04
        needs: build
        if: always()

        steps:
            - name: Set build status
              uses: actions/github-script@v6
              with:
                  script: |
                      const { owner, repo } = context.repo;
                      const sha = context.payload.pull_request.head.sha;
                      const state = '${{ needs.build.result }}' === 'success' ? 'success' : 'failure';
                      const description = state === 'success' ? 'æ„å»ºæˆåŠŸï¼Œäº§ç‰©å·²å‡†å¤‡å°±ç»ª' : 'æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—';

                      await github.rest.repos.createCommitStatus({
                        owner,
                        repo,
                        sha,
                        state,
                        target_url: `https://github.com/${owner}/${repo}/actions/runs/${context.runId}`,
                        description,
                        context: 'PR Build'
                      });
